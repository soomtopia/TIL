## Models.py

웹서비스의 구조를 살펴보면

![models001](/Users/Soomti/soomtopia/TIL/python/models/models001.jpg)

요러케 되어있당, 이걸 django sever 구조로 살펴보면

![models001](/Users/Soomti/soomtopia/TIL/python/models/models002.jpg)

urlconf / view / model / template 으로 구분되는데, databases 접근시에는 view 함수를 통해 DB 접근 시 SQL 을 사용하여 데이터베이스에 자료들에 접근한다. 

### SQL(Structured Query Langage)

Databases 자료에 접근하기 위해 쓰이는 언어. 관계형 DB (RDBMS) 시스템에 쓰이는 언어이다. 

Django 는 RDBMS 만을 지원한다. 또한 sql 에 직접적인 접근 보다는,  ORM Mapper 를 사용해서 Models 에서 SQL을 생성 및 실행한다

### Django Model

SQL 을 직접 짜지 않고, django models 에서 지원해주는 기능. ORM(Object-Relational Mapping) 을 사용하여 python class 와 databases table을 맵핑한다.

- Model class 와 Database table 이 맵핑된다.
- Model instance 와 Database raw 1개가 맵핑된다.

- 1개의 Database 는 여러개의 table 을 가진다.



### model class 생성하기

- 모델 명은 단수형으로 작성한다
- (django.db 의 models 을 사용한다)

```python
from django.db import models
class Post(models.Model):
 title = models.CharField(max_length=100)
 content = models.TextField()
 created_at = models.DateTimeField(auto_now_add=True)
 updated_at = models.DateTimeField(auto_now=True)
```

python 은 char 이나 string 둘다 같은 `_str.py` 를 사용한다. 하지만, database table type 은 구분 되는 type을 써준다. __CharField__ 에서는 max_length 를 지정해줘야하는 짧은 값의 문자열이 등록된다. 하지만 __TextField__ 는 문자열이 긴 data 를 저장해준다. 모든 문자열에 __TextField__ 를 사용해도 가능하지만, 코드 성능을 위해 databases type 과 맞춰 주는것이 좋다. 

#### Fields type

django models 에서는 여러 field type 을 제공한다. 각각의 field type 은 고유한 options 를 가진다. 대표적으로 쓰이는 필드는 아래와 같다. 

- ##### AutoField(**options)

  integer type 의 필드. id 를 autoincrement 할 때 쓰인다. 보통 primary key 가 자동적으로 이 타입을 사용한다. 

- ##### BooleanField

  True / False 의 데이터를 받는 필드. 기본 _checkbox_ 필드이다. 

- ##### CharField

  짧은 문자열의 데이터를 받는 필드. `max_length` 를 필수로 지정해야한다.

- ##### DateTimeField

  시간 형식의 데이터를 받는 필드. 

  ##### option - auto_now_add

  - 1개의 post 가 최초 저장될때의 timestamp 를 가진다.

  __option - auto_now__

  - db data가 갱신될 때마다 created_at 자료가 갱신된다. 

- ##### FileField`(*upload_to=None*, *max_length=100*, **\*options*)`

  파일 형식의 데이터를 받는 필드. 

  __FileField.upload_to__

  파일을 업로드할 디렉토리와 이름을 저장할 수 있다.

  ```python
  class MyModel(models.Model):
      # file will be uploaded to MEDIA_ROOT/uploads
      upload = models.FileField(upload_to='uploads/')
      # or...
      # file will be saved to MEDIA_ROOT/uploads/2015/01/30
      upload = models.FileField(upload_to='uploads/%Y/%m/%d/')
  # or
  def user_directory_path(instance, filename):
      # file will be uploaded to MEDIA_ROOT/user_<id>/<filename>
      return 'user_{0}/{1}'.format(instance.user.id, filename)
  
  class MyModel(models.Model):
      upload = models.FileField(upload_to=user_directory_path)
  ```

- ##### TextField

  긴 문자열의 데이터를 받는 필드

#### 자주 쓰는 options

- __null__: value 값이 null 이 들어와도 되는지의 여부 
- __unique__: 하나의 raw table 에서 고유의 값을 가져야한다. 
- __blank__:  validation 검사 시에 empty 값 허용 여부 (디폴트 : False)
- __default__ : 값이 안들어올 경우 저장될 값 지정. 
- __choices__: form template 에서 select box 로 값을 지정하고 싶을때 주는 data, set 값을 사용하며, 앞의 값은 textfield 의 datatype 을 명시해야한다.
- __validators__ : 유효성 검사를 수행할 함수를 여러개 지정할 수 있다. 기본으로 지정된 validators가 있다.
- __verbose_name__ : 필드 레이블. 지정되지 않으면 필드명이 쓰여짐. 
- __help_text__ : 필드 입력시 아래 도움 메세지 글이 표시된다.



#### blog models 만들어보기

##### blog app 생성 

```python3
$ django-admin start-app blog
```

##### blog admin.py 에 모델 등록

base_url/admin 에 들어가면 해당 모델을 컨트롤 할 수 있다.

```python
from django.contrib import admin

from .models import Post

admin.site.register(Post)
```

모델 생성

```python
from django.db import models
from django.forms import ValidationError
from django.utils import timezone
import re

def lnglat_validator(value):
    if not re.match(r'^(\d+\.?\d*),(\d+\.?\d*)$', value):
        raise ValidationError('위도/경도 방식으로 입력해주세요')

# Create your models here.
class Post(models.Model):
    title = models.CharField(max_length=100)
    content = models.TextField(help_text="content 도움 메세지 입니다")
    tags = models.CharField(max_length=100, blank=True)
    lnglat = models.CharField(max_length=50, validators= [lnglat_validator], help_text='경도,위도 포맷으로 입력')
    created_at = models.DateTimeField(default=timezone.now)
    test_field = models.IntegerField(default=10)
```

##### 마이그레이션 파일 생성

model 을 작성 한 후 `python3 manage.py makemigrations blog` 를 명령어를 치면 마이그레이션 파일을 블로그 밑에 생성해준다

```python
# Generated by Django 2.2.9 on 2020-01-01 08:58

import blog.models
from django.db import migrations, models
import django.utils.timezone


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='Post',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=100)),
                ('content', models.TextField(help_text='content 도움 메세지 입니다')),
                ('tags', models.CharField(blank=True, max_length=100)),
                ('lnglat', models.CharField(help_text='경도,위도 포맷으로 입력', max_length=50, validators=[blog.models.lnglat_validator])),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('test_field', models.IntegerField(default=10)),
            ],
        ),
    ]

```

자동으로 default 되는 값들을 넣어준다. 이후 database 에 적용하기 위해서

```python
$ python3 manage.py migrate 
```

를 하면 데이터베이스에 적용이 된다. 

